<svelte:head>
	<title>SUNstack</title>
</svelte:head>

<script>
		// you may need to edit this code once to get it to work..
		// hacky way to get the userbase code (puttin in svelte:head didn't work)
	  var script = document.createElement( "script" );
    script.src='https://sdk.userbase.com/2/userbase.js';
    document.head.appendChild( script );

    let userObject = null;
    const userbase = window.userbase;
    let authPromise = userbase.init({appId: '3d794443-177f-42ff-83c5-7233f755b132'})
        .then(({user}) => userObject = user)
    let username, password;
    const signIn = () => authPromise = userbase.signIn({username, password}).then(user => userObject = user);
    const signUp = () => authPromise = userbase.signUp({username, password}).then(user => userObject = user);
    const signOut = () => authPromise = userbase.signOut().then(() => userObject = null)
    let todoPromise, todos = [], newTodo = '';
    const databaseName = 'todos';
    function changeHandler(items) {todos = items}
    $: if (userObject) todoPromise = userbase.openDatabase({databaseName, changeHandler})
    function addTodo() {
        todoPromise = userbase.insertItem({databaseName, item: newTodo})
        newTodo = '';
    }
    function deleteTodo(itemId) {
        todoPromise = userbase.deleteItem({databaseName, itemId});
    }
    function updateTodo(index) {
        const {item, itemId} = todos[index];
        todoPromise = userbase.updateItem({databaseName, itemId, item});
    }
</script>

{#await authPromise}Loading...{:then _}
    {#if !userObject}
    <form>
        <label for="username">Username</label>
        <input id="username" type="text" bind:value={username}><br>
        <label for="password">Password</label>
        <input id="password" type="password" bind:value={password}><br>
        <button on:click={signIn} type="button">Sign in</button>
        <button on:click={signUp} type="button">Sign up</button>
    </form>
    {:else}
        <h1>Hi, {userObject.username}!</h1>
        <button on:click={signOut} style="position: absolute; top: 10px; right: 10px;">Log out</button>
        {#await todoPromise}Loading todos..{:then _}
            <label for="new-todo">New Todo</label>
            <input id="new-todo" type="text" bind:value={newTodo}>
            <button on:click={addTodo}>Add todo</button><br>
            {#each todos as {item, itemId}, index}
                <input type="text" bind:value={todos[index].item} on:blur={() => updateTodo(index)}>
                <button on:click={() => deleteTodo(itemId)}>X</button><br>
            {/each}
        {:catch error} Error! {error} {/await}
    {/if}
{:catch error} Error! {error} {/await}